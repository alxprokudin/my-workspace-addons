<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css"/>
    <style>
      body {
        font-family: 'Roboto', Arial, sans-serif;
        padding: 1em;
      }
      #result {
        display: flex;
        flex-direction: column;
        gap: 1em;
        margin-top: 1em;
      }
      .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1em;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        gap: 0.5em;
      }
      .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 1em;
        border-radius: 4px;
      }
      .info-link {
        color: #1976d2;
        text-decoration: none;
        margin-top: 0.5em;
      }
      .info-link:hover {
        text-decoration: underline;
      }
      .loading {
        text-align: center;
        padding: 2em;
        color: #666;
      }
      h3 {
        margin: 0;
        color: #155724;
      }
      /* More specific selector to override add-ons.css */
      #result .success-message .close-button,
      .success-message .close-button,
      button.close-button {
        margin-top: 1em !important;
        padding: 0.75em 1.5em !important;
        background-color: #1976d2 !important;
        background: #1976d2 !important;
        color: white !important;
        border: none !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        min-width: 120px !important;
        transition: background-color 0.2s ease, box-shadow 0.2s ease !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
        display: inline-block !important;
        text-align: center !important;
        text-decoration: none !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
      }
      #result .success-message .close-button:hover,
      .success-message .close-button:hover,
      button.close-button:hover {
        background-color: #1565c0 !important;
        background: #1565c0 !important;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3) !important;
      }
      #result .success-message .close-button:active,
      .success-message .close-button:active,
      button.close-button:active {
        background-color: #0d47a1 !important;
        background: #0d47a1 !important;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
      }
      #result .success-message .close-button:focus,
      .success-message .close-button:focus,
      button.close-button:focus {
        outline: 2px solid #1976d2 !important;
        outline-offset: 2px !important;
      }
    </style>
    <script>
      // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ Google Cloud Console
      // –ù–ï –∫–æ–º–º–∏—Ç—å—Ç–µ —Ñ–∞–π–ª —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ –≤ –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!
      const DEVELOPER_KEY = "–í–ê–®_DEVELOPER_KEY_–ó–î–ï–°–¨";
      const CLOUD_PROJECT_NUMBER = "–í–ê–®_CLOUD_PROJECT_NUMBER_–ó–î–ï–°–¨";

      let pickerApiLoaded = false;
      let oauthToken;

      /**
       * Loads the Google Picker API.
       */
      function onApiLoad() {
        gapi.load("picker", {
          callback: function () {
            pickerApiLoaded = true;
          },
        });
      }

      /**
       * Gets OAuth token from the server and creates the picker.
       */
      function getOAuthToken() {
        showLoading();
        google.script.run
          .withSuccessHandler((token) => {
            if (!token) {
              showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
              return;
            }
            oauthToken = token;
            createPicker(token);
          })
          .withFailureHandler((error) => {
            showError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (error.message || error));
          })
          .getOAuthToken();
      }

      /**
       * Creates and displays the Google Picker for folder selection.
       * @param {string} token - OAuth token for API access.
       */
      function createPicker(token) {
        document.getElementById("result").innerHTML = "";

        if (!pickerApiLoaded) {
          showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Google Picker API. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
          return;
        }

        if (!token) {
          showError("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω.");
          return;
        }

        try {
          const picker = new google.picker.PickerBuilder()
            .addView(
              new google.picker.DocsView()
                .setIncludeFolders(true)
                .setSelectFolderEnabled(true)
                .setMimeTypes('application/vnd.google-apps.folder')
            )
            .enableFeature(google.picker.Feature.NAV_HIDDEN)
            .hideTitleBar()
            .setOAuthToken(token)
            .setDeveloperKey(DEVELOPER_KEY)
            .setAppId(CLOUD_PROJECT_NUMBER)
            .setCallback(pickerCallback)
            .setOrigin(google.script.host.origin)
            .build();
          picker.setVisible(true);
        } catch (error) {
          showError("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Picker: " + (error.message || error));
        }
      }

      /**
       * A callback function that extracts the chosen document's metadata from the
       * response object. For details on the response object, see
       * https://developers.google.com/picker/reference/picker.responseobject
       *
       * @param {object} data The response object.
       */
      function pickerCallback(data) {
        const action = data[google.picker.Response.ACTION];
        if (action == google.picker.Action.PICKED) {
          handlePicked(data);
        } else if (action == google.picker.Action.CANCEL) {
          // document.getElementById("result").innerHTML = "Picker canceled.";
          google.script.host.close()
        }
      }

      /**
       * Handles `"PICKED"` response from the Google Picker.
       * @param {object} data The response object.
       */
      function handlePicked(data) {
        try {
          if (!data || !data[google.picker.Response.DOCUMENTS] || 
              data[google.picker.Response.DOCUMENTS].length === 0) {
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ');
            return;
          }

          const doc = data[google.picker.Response.DOCUMENTS][0];
          const id = doc[google.picker.Document.ID];

          if (!id) {
            showError('–ù–µ–≤–µ—Ä–Ω—ã–π ID –ø–∞–ø–∫–∏');
            return;
          }

          showLoading('–≠–∫—Å–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞...');

          google.script.run
            .withSuccessHandler((response) => {
              if (response && response.success) {
                showSuccess(response);
                // Close dialog after 10 seconds
                setTimeout(() => {
                  google.script.host.close();
                }, 10000);
              } else {
                showError(response && response.message ? response.message : 
                  '–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞');
              }
            })
            .withFailureHandler((error) => {
              showError('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + (error.message || error));
            })
            .getExcelFromAnySheet(id);
        } catch (error) {
          showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞: ' + (error.message || error));
        }
      }

      /**
       * Displays an error message to the user.
       * @param {string} message - Error message to display.
       */
      function showError(message) {
        const resultElement = document.getElementById("result");
        resultElement.innerHTML = `
          <div class="error-message">
            <strong>–û—à–∏–±–∫–∞:</strong> ${escapeHtml(message)}
          </div>
        `;
      }

      /**
       * Displays a success message with file information.
       * @param {Object} response - Response object from server.
       */
      function showSuccess(response) {
        const resultElement = document.getElementById("result");
        resultElement.innerHTML = `
          <div class="success-message">
            <h3>‚úì –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!</h3>
            <div><strong>–§–∞–π–ª:</strong> ${escapeHtml(response.fileName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}</div>
            <div><strong>–ü–∞–ø–∫–∞:</strong> ${escapeHtml(response.folderName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}</div>
            <div style="margin-top: 1em; padding-top: 1em; border-top: 1px solid #c3e6cb;">
              <div style="margin-bottom: 0.5em; color: #666; font-size: 13px;">–ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏:</div>
              <a href="${response.fileUrl || '#'}" target="_blank" class="info-link">
                üìÑ –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –≤ Google Drive
              </a>
              <a href="${response.folderUrl || '#'}" target="_blank" class="info-link">
                üìÅ –û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É –≤ Google Drive
              </a>
            </div>
            <button class="close-button" onclick="google.script.host.close()" style="margin-top: 1em; padding: 0.75em 1.5em; background-color: #1976d2; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; min-width: 120px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); display: inline-block; text-align: center; -webkit-appearance: none; -moz-appearance: none; appearance: none;">
              –ó–∞–∫—Ä—ã—Ç—å
            </button>
          </div>
        `;
      }

      /**
       * Shows a loading message.
       * @param {string} message - Loading message to display.
       */
      function showLoading(message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
        const resultElement = document.getElementById("result");
        resultElement.innerHTML = `<div class="loading">${escapeHtml(message)}</div>`;
      }

      /**
       * Escapes HTML to prevent XSS attacks.
       * @param {string} text - Text to escape.
       * @return {string} Escaped text.
       */
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </head>

  <body>
    <div>
      <div id="result"></div>
    </div>
    <script>
      window.onload = () => getOAuthToken()
    </script>
    <script src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
  </body>
</html>
