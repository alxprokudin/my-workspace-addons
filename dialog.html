<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css"/>
    <style>
      body {
        font-family: 'Roboto', Arial, sans-serif;
        padding: 1em;
      }
      #result {
        display: flex;
        flex-direction: column;
        gap: 1em;
        margin-top: 1em;
      }
      .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1em;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        gap: 0.5em;
      }
      .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 1em;
        border-radius: 4px;
      }
      .info-link {
        color: #1976d2;
        text-decoration: none;
        margin-top: 0.5em;
      }
      .info-link:hover {
        text-decoration: underline;
      }
      .loading {
        text-align: center;
        padding: 2em;
        color: #666;
      }
      h3 {
        margin: 0;
        color: #155724;
      }
      .close-button {
        margin-top: 1em;
        padding: 0.5em 1em;
        background-color: #1976d2;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .close-button:hover {
        background-color: #1565c0;
      }
    </style>
    <script>
      const DEVELOPER_KEY = "AIzaSyCeKsJs2wuDIv8nxDd6hUS77FgQdFhnbgY";
      const CLOUD_PROJECT_NUMBER = "1023595276216";

      let pickerApiLoaded = false;
      let oauthToken;

      /**
       * Loads the Google Picker API.
       */
      function onApiLoad() {
        gapi.load("picker", {
          callback: function () {
            pickerApiLoaded = true;
          },
        });
      }

      /**
       * Gets OAuth token from the server and creates the picker.
       */
      function getOAuthToken() {
        showLoading();
        google.script.run
          .withSuccessHandler((token) => {
            if (!token) {
              showError('Не удалось получить токен авторизации');
              return;
            }
            oauthToken = token;
            createPicker(token);
          })
          .withFailureHandler((error) => {
            showError('Ошибка авторизации: ' + (error.message || error));
          })
          .getOAuthToken();
      }

      /**
       * Creates and displays the Google Picker for folder selection.
       * @param {string} token - OAuth token for API access.
       */
      function createPicker(token) {
        document.getElementById("result").innerHTML = "";

        if (!pickerApiLoaded) {
          showError("Ошибка загрузки Google Picker API. Пожалуйста, обновите страницу.");
          return;
        }

        if (!token) {
          showError("Ошибка авторизации. Токен не получен.");
          return;
        }

        try {
          const picker = new google.picker.PickerBuilder()
            .addView(
              new google.picker.DocsView()
                .setIncludeFolders(true)
                .setSelectFolderEnabled(true)
                .setMimeTypes('application/vnd.google-apps.folder')
            )
            .enableFeature(google.picker.Feature.NAV_HIDDEN)
            .hideTitleBar()
            .setOAuthToken(token)
            .setDeveloperKey(DEVELOPER_KEY)
            .setAppId(CLOUD_PROJECT_NUMBER)
            .setCallback(pickerCallback)
            .setOrigin(google.script.host.origin)
            .build();
          picker.setVisible(true);
        } catch (error) {
          showError("Ошибка при создании Picker: " + (error.message || error));
        }
      }

      /**
       * A callback function that extracts the chosen document's metadata from the
       * response object. For details on the response object, see
       * https://developers.google.com/picker/reference/picker.responseobject
       *
       * @param {object} data The response object.
       */
      function pickerCallback(data) {
        const action = data[google.picker.Response.ACTION];
        if (action == google.picker.Action.PICKED) {
          handlePicked(data);
        } else if (action == google.picker.Action.CANCEL) {
          // document.getElementById("result").innerHTML = "Picker canceled.";
          google.script.host.close()
        }
      }

      /**
       * Handles `"PICKED"` response from the Google Picker.
       * @param {object} data The response object.
       */
      function handlePicked(data) {
        try {
          if (!data || !data[google.picker.Response.DOCUMENTS] || 
              data[google.picker.Response.DOCUMENTS].length === 0) {
            showError('Не удалось получить информацию о выбранной папке');
            return;
          }

          const doc = data[google.picker.Response.DOCUMENTS][0];
          const id = doc[google.picker.Document.ID];

          if (!id) {
            showError('Неверный ID папки');
            return;
          }

          showLoading('Экспорт файла...');

          google.script.run
            .withSuccessHandler((response) => {
              if (response && response.success) {
                showSuccess(response);
                // Close dialog after 3 seconds
                setTimeout(() => {
                  google.script.host.close();
                }, 3000);
              } else {
                showError(response && response.message ? response.message : 
                  'Ошибка при экспорте файла');
              }
            })
            .withFailureHandler((error) => {
              showError('Ошибка экспорта: ' + (error.message || error));
            })
            .getExcelFromAnySheet(id);
        } catch (error) {
          showError('Ошибка обработки выбора: ' + (error.message || error));
        }
      }

      /**
       * Displays an error message to the user.
       * @param {string} message - Error message to display.
       */
      function showError(message) {
        const resultElement = document.getElementById("result");
        resultElement.innerHTML = `
          <div class="error-message">
            <strong>Ошибка:</strong> ${escapeHtml(message)}
          </div>
        `;
      }

      /**
       * Displays a success message with file information.
       * @param {Object} response - Response object from server.
       */
      function showSuccess(response) {
        const resultElement = document.getElementById("result");
        resultElement.innerHTML = `
          <div class="success-message">
            <h3>✓ Экспорт выполнен успешно!</h3>
            <div><strong>Файл:</strong> ${escapeHtml(response.fileName || 'Неизвестно')}</div>
            <div><strong>Папка:</strong> ${escapeHtml(response.folderName || 'Неизвестно')}</div>
            <a href="${response.fileUrl || '#'}" target="_blank" class="info-link">
              Открыть файл в Google Drive
            </a>
            <a href="${response.folderUrl || '#'}" target="_blank" class="info-link">
              Открыть папку в Google Drive
            </a>
            <button class="close-button" onclick="google.script.host.close()">
              Закрыть
            </button>
          </div>
        `;
      }

      /**
       * Shows a loading message.
       * @param {string} message - Loading message to display.
       */
      function showLoading(message = 'Загрузка...') {
        const resultElement = document.getElementById("result");
        resultElement.innerHTML = `<div class="loading">${escapeHtml(message)}</div>`;
      }

      /**
       * Escapes HTML to prevent XSS attacks.
       * @param {string} text - Text to escape.
       * @return {string} Escaped text.
       */
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </head>

  <body>
    <div>
      <div id="result"></div>
    </div>
    <script>
      window.onload = () => getOAuthToken()
    </script>
    <script src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
  </body>
</html>
